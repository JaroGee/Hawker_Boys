generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  TRAINEE
  MENTOR
  EMPLOYER
  ADMIN
}

enum AnnouncementAudience {
  ALL
  TRAINEES
  MENTORS
  EMPLOYERS
}

enum QuestStatus {
  LOCKED
  ACTIVE
  DONE
}

enum SecureOwnerType {
  TRAINEE
  EMPLOYER
}

enum SecureDocumentCategory {
  MC
  BANK
  OFFICIAL
  OTHER
}

enum ShiftStatus {
  PLANNED
  CONFIRMED
  CANCELLED
}

enum ComplianceType {
  URINE_TEST
  APPOINTMENT
  LEAVE
}

enum SupportStatus {
  OPEN
  PENDING
  CLOSED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  role         Role
  passwordHash String?
  createdAt    DateTime @default(now())
  trainee      TraineeProfile?
  mentor       MentorProfile?
  employer     EmployerProfile?
  assessments  Assessment[] @relation("MentorAssessments")
  supportTickets SupportTicket[] @relation("SupportResponder")
}

model TraineeProfile {
  userId     String  @id
  user       User    @relation(fields: [userId], references: [id])
  name       String
  avatarUrl  String?
  cohort     String?
  certifications TraineeCertification[]
  emergencyContacts EmergencyContact[]
  shifts     Shift[]
  compliance ComplianceEvent[]
  documents  SecureDocument[] @relation("TraineeDocuments")
  tickets    SupportTicket[]
  questProgress QuestProgress[]
  badges     TraineeBadge[]
  assessments Assessment[] @relation("TraineeAssessments")
  feedback   CustomerFeedback[]
  liveSessions LiveLocationSession[]
}

model MentorProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])
  bio    String?
  trainees Assessment[] @relation("MentorAssessments")
}

model EmployerProfile {
  userId      String @id
  user        User   @relation(fields: [userId], references: [id])
  companyName String
  shifts      Shift[]
  documents   SecureDocument[] @relation("EmployerDocuments")
}

model Announcement {
  id          String                @id @default(cuid())
  title       String
  body        String
  audience    AnnouncementAudience @default(ALL)
  publishedAt DateTime?
}

model Certification {
  id    String @id @default(cuid())
  code  String @unique
  name  String
  level Int?
  traineeCertifications TraineeCertification[]
}

model TraineeCertification {
  id              String   @id @default(cuid())
  traineeId       String
  trainee         TraineeProfile @relation(fields: [traineeId], references: [userId])
  certificationId String
  certification   Certification  @relation(fields: [certificationId], references: [id])
  issuedAt        DateTime
  evidenceUrl     String?
}

model AssessmentTemplate {
  id       String   @id @default(cuid())
  name     String
  criteria Json
  assessments Assessment[]
}

model Assessment {
  id         String   @id @default(cuid())
  traineeId  String
  trainee    TraineeProfile @relation("TraineeAssessments", fields: [traineeId], references: [userId])
  mentorId   String
  mentor     User   @relation("MentorAssessments", fields: [mentorId], references: [id])
  templateId String
  template   AssessmentTemplate @relation(fields: [templateId], references: [id])
  scores     Json
  notes      String?
  createdAt  DateTime @default(now())
}

model CustomerFeedback {
  id          String   @id @default(cuid())
  traineeId   String
  trainee     TraineeProfile @relation(fields: [traineeId], references: [userId])
  rating      Int
  comment     String
  receiptCode String?
  createdAt   DateTime @default(now())
  meta        Json?
}

model Quest {
  id          String   @id @default(cuid())
  title       String
  description String
  points      Int
  startAt     DateTime?
  endAt       DateTime?
  progress    QuestProgress[]
}

model QuestProgress {
  id        String   @id @default(cuid())
  questId   String
  quest     Quest    @relation(fields: [questId], references: [id])
  traineeId String
  trainee   TraineeProfile @relation(fields: [traineeId], references: [userId])
  status    QuestStatus @default(LOCKED)
  updatedAt DateTime @default(now())
}

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  title       String
  description String
  icon        String?
  traineeBadges TraineeBadge[]
}

model TraineeBadge {
  id        String   @id @default(cuid())
  traineeId String
  trainee   TraineeProfile @relation(fields: [traineeId], references: [userId])
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  awardedAt DateTime @default(now())
}

model SecureDocument {
  id         String   @id @default(cuid())
  ownerType  SecureOwnerType
  traineeId  String?
  trainee    TraineeProfile? @relation("TraineeDocuments", fields: [traineeId], references: [userId])
  employerId String?
  employer   EmployerProfile? @relation("EmployerDocuments", fields: [employerId], references: [userId])
  category   SecureDocumentCategory
  filename   String
  mime       String
  size       Int
  storageKey String
  createdAt  DateTime @default(now())
}

model EmergencyContact {
  id            String   @id @default(cuid())
  traineeId     String
  trainee       TraineeProfile @relation(fields: [traineeId], references: [userId])
  name          String
  relationship  String
  phone         String
  email         String?
  address       String?
  preferred     Boolean @default(false)
}

model Shift {
  id         String   @id @default(cuid())
  traineeId  String
  trainee    TraineeProfile @relation(fields: [traineeId], references: [userId])
  employerId String
  employer   EmployerProfile @relation(fields: [employerId], references: [userId])
  start      DateTime
  end        DateTime
  location   String
  notes      String?
  status     ShiftStatus @default(PLANNED)
}

model ComplianceEvent {
  id        String   @id @default(cuid())
  traineeId String
  trainee   TraineeProfile @relation(fields: [traineeId], references: [userId])
  type      ComplianceType
  start     DateTime
  end       DateTime?
  notes     String?
  evidenceDocumentId String?
}

model SupportTicket {
  id          String   @id @default(cuid())
  traineeId   String?
  trainee     TraineeProfile? @relation(fields: [traineeId], references: [userId])
  category    String
  message     String
  createdAt   DateTime @default(now())
  status      SupportStatus @default(OPEN)
  responderId String?
  responder   User? @relation("SupportResponder", fields: [responderId], references: [id])
}

model LiveLocationSession {
  id               String   @id @default(cuid())
  traineeId        String
  trainee          TraineeProfile @relation(fields: [traineeId], references: [userId])
  token            String   @unique
  requestedByUserId String
  requestedBy      User     @relation(fields: [requestedByUserId], references: [id])
  expiresAt        DateTime
  active           Boolean @default(false)
  pings            LiveLocationPing[]
}

model LiveLocationPing {
  id        String   @id @default(cuid())
  sessionId String
  session   LiveLocationSession @relation(fields: [sessionId], references: [id])
  lat       Float
  lng       Float
  accuracy  Float?
  at        DateTime
}

model AuditEvent {
  id        String   @id @default(cuid())
  userId    String?
  actorRole Role
  action    String
  entity    String
  entityId  String?
  meta      Json?
  at        DateTime @default(now())
}
